<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Order Tracking</title>
    <meta name="color-scheme" content="light dark" />
    <style>
        :root{
          --brand:#9B1C1C;   /* deep red */
          --brand-2:#D32F2F; /* mid red */
          --ok:#10B981;      /* green */
          --warn:#E11D48;    /* red-rose */
          --ink:#111827;
          --muted:#6B7280;
          --card:#ffffff;
          --bg:#FAFAFA;
          --ring: rgba(0,0,0,.08);
        }
        @media (prefers-color-scheme: dark){
          :root{
            --card:#0b0b0b; --bg:#050505; --ink:#e5e7eb; --muted:#9CA3AF;
            --ring: rgba(255,255,255,.10);
          }
        }
        *{box-sizing:border-box}
        body{
          margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji","Segoe UI Emoji";
          background:var(--bg); color:var(--ink);
        }
        .container{
          max-width:960px; margin-inline:auto; padding:16px;
        }
        header{
          display:flex; align-items:center; gap:12px; padding:12px 0;
        }
        .logo{
          width:38px; height:38px; border-radius:10px;
          background: linear-gradient(135deg,var(--brand),var(--brand-2));
          display:grid; place-items:center; color:white; font-weight:900;
        }
        h1{font-size:clamp(18px,3vw,22px); margin:0; font-weight:800}
        .muted{ color:var(--muted) }

        .card{
          background:var(--card); border:1px solid var(--ring); border-radius:16px;
          box-shadow: 0 2px 10px var(--ring);
        }
        .pad{ padding:16px }
        .grid{ display:grid; gap:12px }
        @media (min-width:740px){ .grid-2{ grid-template-columns: 1fr 1fr } }
        .row{ display:flex; align-items:center; gap:8px }
        .btn{
          display:inline-flex; align-items:center; gap:8px;
          background:var(--brand); color:white; padding:10px 14px; border:none;
          border-radius:12px; font-weight:800; cursor:pointer;
        }
        .btn:disabled{ opacity:.5; cursor:not-allowed }
        .input{
          width:100%; padding:12px 14px; border:1px solid var(--ring);
          border-radius:12px; background:var(--card); color:inherit;
          outline:none;
        }
        .input:focus{ border-color: var(--brand) }

        .badge{
          display:inline-flex; align-items:center; gap:6px;
          padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px;
          border:1px solid var(--ring); background:var(--bg);
        }
        .kpi{
          display:grid; gap:6px; padding:12px; border-radius:12px; border:1px solid var(--ring);
        }
        .kpi .val{ font-size:22px; font-weight:900 }
        .kpi.ok{ border-color: rgba(16,185,129,.4) }
        .kpi.warn{ border-color: rgba(225,29,72,.4) }

        /* progress bar */
        .progress{ height:10px; background:var(--ring); border-radius:999px; overflow:hidden }
        .progress>span{ display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand-2)) }

        /* timeline */
        .timeline{ position:relative; padding-left:22px }
        .timeline::before{
          content:""; position:absolute; left:9px; top:0; bottom:0; width:2px; background:var(--ring);
        }
        .step{
          position:relative; padding:10px 0 10px 12px;
        }
        .step::before{
          content:""; position:absolute; left:-2px; top:16px; width:10px; height:10px;
          background:var(--bg); border:2px solid var(--brand); border-radius:50%;
        }
        .step.done::before{ background:var(--brand) }
        .step .title{ font-weight:900 }
        .pill{
          padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800;
          background: rgba(16,185,129,.12); color: var(--ok);
          border:1px solid rgba(16,185,129,.35);
        }
        .pill.warn{
          background: rgba(225,29,72,.10); color: var(--warn);
          border-color: rgba(225,29,72,.35);
        }

        .updates li{ display:flex; gap:10px; padding:10px 0; border-bottom:1px dashed var(--ring) }
        .updates time{ color:var(--muted); white-space:nowrap }
        .center{ text-align:center; padding:16px }
        a{ color:var(--brand) }
    </style>
</head>
<body>
<div class="container">
    <header>
        <div class="logo">U</div>
        <div>
            <h1>Track your Work Order</h1>
            <div class="muted">Enter your Work Order (e.g. <code>WO-12345</code>)</div>
        </div>
    </header>

    <!-- Search -->
    <div class="card pad grid grid-2" style="align-items:end">
        <div>
            <label class="muted" for="orderInput">Work Order Number</label>
            <input id="orderInput" class="input" placeholder="WO-12345" />
        </div>
        <div class="row" style="gap:10px; flex-wrap:wrap">
            <button id="searchBtn" class="btn"><span>Search</span></button>
            <span id="statusBadge" class="badge muted" style="display:none"></span>
        </div>
    </div>

    <!-- Results -->
    <div id="results" style="margin-top:14px; display:none" class="grid grid-2">
        <!-- Left: summary -->
        <div class="card pad grid" id="summaryCard">
            <div class="row" style="justify-content:space-between; align-items:start">
                <div>
                    <div class="muted">Work Order</div>
                    <div id="wo" style="font-weight:900; font-size:20px">—</div>
                </div>
                <div class="badge" id="status">Status: —</div>
            </div>

            <div class="grid" style="grid-template-columns: repeat(2,minmax(0,1fr)); gap:10px">
                <div class="kpi">
                    <div class="muted">Buyer</div>
                    <div class="val" id="buyer">—</div>
                </div>
                <div class="kpi">
                    <div class="muted">Style</div>
                    <div class="val" id="style">—</div>
                </div>
                <div class="kpi">
                    <div class="muted">Total Stages</div>
                    <div class="val" id="totalStages">—</div>
                </div>
                <div class="kpi ok" title="Completed stages">
                    <div class="muted">Completed</div>
                    <div class="val" id="doneStages">—</div>
                </div>
            </div>

            <div>
                <div class="muted row" style="justify-content:space-between">
                    <span>Progress</span>
                    <span id="progressText" class="muted">0%</span>
                </div>
                <div class="progress"><span id="progressBar" style="width:0%"></span></div>
            </div>

            <div class="row" style="gap:6px; flex-wrap:wrap">
                <div id="etaPill" class="pill" style="display:none"></div>
                <div id="leadTimePill" class="pill" style="display:none"></div>
            </div>
        </div>

        <!-- Right: timeline -->
        <div class="card pad">
            <div class="row" style="justify-content:space-between">
                <div style="font-weight:900">Production Timeline</div>
                <div class="muted" id="stageCount">—</div>
            </div>
            <div id="timeline" class="timeline" style="margin-top:8px"></div>
        </div>

        <!-- Full-width: updates -->
        <div class="card pad" style="grid-column: 1/-1">
            <div style="font-weight:900">Latest Updates</div>
            <ul id="updates" class="updates" style="list-style:none; padding:0; margin:8px 0 0"></ul>
        </div>
    </div>

    <div id="empty" class="center muted">Search to see order details.</div>
</div>

<!-- Firebase (Compat for simplest inline use) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
    // 1) Fill your Firebase web config here (Project settings → General → Web app)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Helpers
    const $ = (id) => document.getElementById(id);
    const fmtDate = (d) => d ? new Date(d).toLocaleString() : "—";
    const daysBetween = (a,b) => {
      if(!a || !b) return null;
      const ms = Math.abs(b - a);
      return Math.max(1, Math.round(ms / (1000*60*60*24))); // at least 1 day
    };

    async function fetchOrder(orderNo){
      const snap = await db.collection('work_orders')
        .where('orderNo','==', orderNo.trim())
        .where('isPublic','==', true)      // gate public viewing
        .limit(1)
        .get();
      if (snap.empty) return null;
      const doc = snap.docs[0];
      const data = doc.data();
      data._id = doc.id;

      // also get updates (latest 20)
      const updates = await db.collection('work_orders').doc(doc.id)
        .collection('updates').orderBy('ts','desc').limit(20).get();
      data._updates = updates.docs.map(d => d.data());
      return data;
    }

    function render(data){
      if(!data){ $('results').style.display='none'; $('empty').textContent='No order found.'; return; }
      $('results').style.display='grid';
      $('empty').style.display='none';

      $('wo').textContent = data.orderNo || '—';
      $('buyer').textContent = data.buyerName || '—';
      $('style').textContent = data.style || '—';

      const statusText = data.status || '—';
      $('status').textContent = `Status: ${statusText}`;
      const badge = $('status');
      badge.style.borderColor = 'var(--ring)';
      if (statusText.toLowerCase().includes('complete') || statusText.toLowerCase().includes('packed')) {
        badge.style.borderColor = 'rgba(16,185,129,.4)';
      }

      const stages = Array.isArray(data.stages) ? data.stages : [];
      const total = stages.length;
      const done  = stages.filter(s => s.completedAt).length;

      $('totalStages').textContent = total;
      $('doneStages').textContent = done;
      const pct = total ? Math.round((done/total)*100) : 0;
      $('progressBar').style.width = pct + '%';
      $('progressText').textContent = pct + '%';
      $('stageCount').textContent = `${done}/${total} completed`;

      // Overall lead time (first start to last completed)
      if (total){
        const firstStart = stages.find(s => s.startedAt)?.startedAt?.toDate?.() || null;
        const lastDone  = [...stages].reverse().find(s => s.completedAt)?.completedAt?.toDate?.() || null;
        if (firstStart && lastDone){
          const d = daysBetween(firstStart,lastDone);
          $('leadTimePill').style.display = 'inline-flex';
          $('leadTimePill').textContent = `Lead time: ${d} day(s)`;
        } else {
          $('leadTimePill').style.display = 'none';
        }
      }

      // ETA (if expectedShip exists)
      if (data.expectedShip?.toDate){
        const eta = data.expectedShip.toDate();
        $('etaPill').style.display = 'inline-flex';
        $('etaPill').className = 'pill' + (eta < new Date() && done < total ? ' warn' : '');
        const left = daysBetween(new Date(), eta);
        $('etaPill').textContent = (eta < new Date() && done < total)
          ? `ETA passed: ${left} day(s) ago`
          : `ETA in ${left} day(s)`;
      } else {
        $('etaPill').style.display = 'none';
      }

      // Timeline with stage-to-stage durations
      const wrap = $('timeline');
      wrap.innerHTML = '';
      let prevDone = null;
      stages.forEach((s,i) => {
        const started = s.startedAt?.toDate?.();
        const doneAt  = s.completedAt?.toDate?.();
        const li = document.createElement('div');
        li.className = 'step' + (doneAt ? ' done':'');
        const between = (prevDone && doneAt) ? daysBetween(prevDone, doneAt) : null;

        li.innerHTML = `
          <div class="title">${s.name || `Stage ${i+1}`}</div>
          <div class="muted" style="font-size:13px">
            Started: ${fmtDate(started)} • Completed: ${fmtDate(doneAt)}
          </div>
          <div class="row" style="gap:6px; margin-top:6px">
            ${ between ? `<div class="pill">From last stage: ${between} day(s)</div>` : '' }
            ${ doneAt ? '' : '<div class="pill warn">In progress</div>' }
            ${ s.note ? `<div class="badge" title="Note">${s.note}</div>`:''}
          </div>
        `;
        wrap.appendChild(li);
        if (doneAt) prevDone = doneAt;
      });

      // Updates
      const ul = $('updates'); ul.innerHTML = '';
      if (data._updates && data._updates.length){
        data._updates.forEach(u=>{
          const li = document.createElement('li');
          const when = u.ts?.toDate?.() || null;
          li.innerHTML = `<time>${when ? new Date(when).toLocaleString() : ''}</time><div>${u.msg || ''}</div>`;
          ul.appendChild(li);
        });
      } else {
        ul.innerHTML = '<li class="muted">No recent updates</li>';
      }
    }

    $('searchBtn').addEventListener('click', async ()=>{
      const x = $('orderInput').value.trim();
      if (!x) { $('statusBadge').style.display='inline-flex'; $('statusBadge').textContent='Enter a work order number'; return; }
      $('statusBadge').style.display='inline-flex'; $('statusBadge').textContent='Searching…';
      try{
        const data = await fetchOrder(x);
        render(data);
        $('statusBadge').textContent = data ? 'Found' : 'Not found';
      }catch(e){
        console.error(e);
        $('statusBadge').textContent = 'Error loading';
      }
    });

    // Submit on Enter
    $('orderInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter') $('searchBtn').click(); });
</script>
</body>
</html>
